<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="vacation">

	<!-- 기본 연차 정보 조회 -->
	<select id="vacInfo" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$VacationInfo">
		SELECT *
		FROM VACATION_BASIC
		ORDER BY WORK_LV ASC
	</select>
	
	<!-- 모든 사원 휴가 내역 검색 -->
	<select id="allVacation" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$MemberVacation">
	SELECT
		V.USER_NO,
		M.USER_NAME,
		V.VAC_ID,
		T.VAC_NAME,
		V.VAC_START,
		V.VAC_END,
		V.VAC_AMOUNT,
		V.STATUS
	FROM VACATION V
	LEFT JOIN MEMBER M ON M.USER_NO = V.USER_NO
	LEFT JOIN VACATION_TYPE T ON T.VAC_CODE = V.VAC_CODE
	WHERE
		EXTRACT(YEAR FROM V.VAC_START) = #{year} AND
		EXTRACT(MONTH FROM V.VAC_START) = TO_NUMBER(#{month})
	ORDER BY VAC_ID DESC
	</select>
	
	<!-- 사원 검색 -->
	<select id="memChoice" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$MemberChoice">
		SELECT 
			USER_NO,
			USER_NAME,
			DEP_NAME,
			POS_NAME,
			HIRE_DATE
		FROM MEMBER
		LEFT JOIN DEPARTMENT USING(DEP_ID)
		LEFT JOIN POSITIONS USING(POS_ID)
		WHERE USER_NAME Like '%' || #{userName} || '%'
		ORDER BY USER_NO ASC
	</select>
	
	<!-- 검색 사원 휴가 내역 조회 -->
	<select id="memVacation" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$MemberVacation">
		SELECT
			V.USER_NO,
			M.USER_NAME,
			V.VAC_ID,
			T.VAC_NAME,
			V.VAC_START,
			V.VAC_END,
			V.VAC_AMOUNT,
			V.STATUS
		FROM VACATION V
		LEFT JOIN MEMBER M ON M.USER_NO = V.USER_NO
		LEFT JOIN VACATION_TYPE T ON T.VAC_CODE = V.VAC_CODE
		WHERE
			V.USER_NO = #{userNo} AND
			EXTRACT(YEAR FROM V.VAC_START) = #{year} AND
			EXTRACT(MONTH FROM V.VAC_START) = TO_NUMBER(#{month})
		ORDER BY VAC_ID DESC
	</select>
	
	<!-- 휴가 승인 상태 업데이트 -->
	<update id="vacStatusUpdate">
		UPDATE VACATION
		SET STATUS = #{putVacStatus.status}
		WHERE VAC_ID = #{vacId}
	</update>
	
	<!-- 로그인 사원 프로필 조회 -->
	<select id="loginUserProfile" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$LoginUser">
		SELECT
			USER_NAME,
			DEP_NAME,
			POS_NAME,
			HIRE_DATE
		FROM MEMBER
		LEFT JOIN DEPARTMENT USING(DEP_ID)
		LEFT JOIN POSITIONS USING(POS_ID)
		WHERE USER_NO = #{userNo}
	</select>
	
	<!-- 휴가 종류 조회 -->
	<select id="vacType" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$VacType">
		SELECT
			VAC_CODE,
			VAC_NAME
		FROM VACATION_TYPE
		WHERE VAC_CODE >= 4
		ORDER BY VAC_CODE ASC
	</select>
	
	<!-- 로그인 사원 휴가 내역 조회 -->
	<select id="perVacation" resultType="com.kh.coreflow.humanmanagement.model.dto.VacationDto$MemberVacation">
		SELECT
			V.USER_NO,
			M.USER_NAME,
			M.HIRE_DATE,
			T.VAC_NAME,
			V.VAC_START,
			V.VAC_END,
			V.VAC_AMOUNT,
			V.STATUS
		FROM VACATION V
		LEFT JOIN MEMBER M ON M.USER_NO = V.USER_NO
		LEFT JOIN VACATION_TYPE T ON T.VAC_CODE = V.VAC_CODE
		WHERE
			V.USER_NO = #{userNo} AND
			EXTRACT(YEAR FROM V.VAC_START) = #{year}
		ORDER BY VAC_ID DESC
	</select>
	
	<insert id="putPerVac" parameterType="map">
		INSERT INTO VACATION(VAC_CODE, USER_NO, VAC_START, VAC_END, VAC_AMOUNT)
		VALUES(#{putVacation.vacCode}, #{userNo}, #{putVacation.vacStart}, #{putVacation.vacEnd},#{putVacation.vacAmount})
	</insert>
</mapper>