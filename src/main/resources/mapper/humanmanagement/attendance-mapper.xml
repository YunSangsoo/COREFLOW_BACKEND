<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="attendance">
	
	<!-- 사원 근태 기록 조회(일별) -->
	<select id="memAttendance" resultType="com.kh.coreflow.humanmanagement.model.dto.AttendanceDto$AttendanceInfo">
		SELECT
			A.ATT_ID,
		    A.ATT_DATE,
		    M.USER_NAME,
		    D.DEP_NAME,
		    P.POS_NAME,
		    A.CHECK_IN_TIME,
		    A.CHECK_OUT_TIME,
		    T.VAC_NAME
		FROM ATTENDANCE A
		LEFT JOIN MEMBER M ON M.USER_NO = A.USER_NO
		LEFT JOIN DEPARTMENT D ON D.DEP_ID = M.DEP_ID
		LEFT JOIN POSITIONS P ON P.POS_ID = M.POS_ID
		LEFT JOIN VACATION_TYPE T ON T.VAC_CODE = A.STATUS
		WHERE A.ATT_DATE = #{attDate}
		<if test="userNo != null">
			AND A.USER_NO = #{userNo}
		</if>
		ORDER BY A.ATT_ID DESC
	</select>
	
	<!-- 로그인 사용자 근태 기록 조회(월별) -->
	<select id="perAttendance" resultType="com.kh.coreflow.humanmanagement.model.dto.AttendanceDto$AttendanceInfo">
		SELECT
			A.ATT_ID,
			A.ATT_DATE,
		    M.USER_NAME,
		    D.DEP_NAME,
		    P.POS_NAME,
		    A.CHECK_IN_TIME,
		    A.CHECK_OUT_TIME,
		    T.VAC_NAME
		FROM ATTENDANCE A
		LEFT JOIN MEMBER M ON M.USER_NO = A.USER_NO
		LEFT JOIN DEPARTMENT D ON D.DEP_ID = M.DEP_ID
		LEFT JOIN POSITIONS P ON P.POS_ID = M.POS_ID
		LEFT JOIN VACATION_TYPE T ON T.VAC_CODE = A.STATUS
		WHERE A.USER_NO = #{userNo} AND
			  EXTRACT(YEAR FROM TO_DATE(A.ATT_DATE, 'YYYY/MM/DD')) = #{year} AND
			  EXTRACT(MONTH FROM TO_DATE(A.ATT_DATE, 'YYYY/MM/DD')) = LPAD(#{month},2,'0')
		ORDER BY A.ATT_ID DESC
	</select>
	
	<!-- 출근버튼 -->
	<insert id="checkIn" parameterType="map">
		INSERT INTO ATTENDANCE(ATT_DATE,USER_NO, CHECK_IN_TIME,STATUS)
		VALUES(#{checkIn.attDate}, #{userNo}, #{checkIn.checkInTime}, #{checkIn.status})
	</insert>

	<!-- 퇴근버튼 -->
	<update id="checkOut">
		UPDATE ATTENDANCE
		SET CHECK_OUT_TIME = #{checkOutTime}
		WHERE ATT_ID = #{attId}
	</update>
	
	<!-- 비고 목록 조회 -->
	<select id="vacTypeList" resultType="com.kh.coreflow.humanmanagement.model.dto.AttendanceDto$VacType">
		SELECT
			VAC_CODE,
			VAC_NAME
		FROM VACATION_TYPE
		ORDER BY VAC_CODE ASC
	</select>
	
	<!-- 비고 수정 -->
	<update id="vacTypeUpdate">
		UPDATE ATTENDANCE
		SET STATUS = #{vacCode}
		WHERE ATT_ID = #{attId} 
	</update>
</mapper>