<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="calendar">

  <!-- 공통 컬럼: DEP_ID 사용 -->
  <sql id="BaseCols">
    CAL_ID, CAL_NAME, COLOR, DEFAULT_ROLE,
    OWNER_USER_NO, DEP_ID, DELETED_YN, CREATE_DATE, UPDATE_DATE
  </sql>

  <!-- 내가 볼 수 있는 캘린더 목록(개인/멤버/부서/직급 공유 반영) -->
  <select id="selectVisibleCalendars"
          parameterType="map"
          resultType="com.kh.coreflow.calendar.model.dto.CalendarDto$SummaryRes">
    WITH MY_ORG AS (
      SELECT DEP_ID, POS_ID
      FROM MEMBER
      WHERE USER_NO = #{userNo}
    )
    SELECT
      c.CAL_ID   AS calId,
      c.CAL_NAME AS calName,
      c.COLOR    AS color,
      CASE WHEN c.OWNER_USER_NO = #{userNo} THEN 1 ELSE 0 END AS isPersonal,
      CASE WHEN c.OWNER_USER_NO = #{userNo} THEN 1 ELSE 0 END AS defaultForMe
    FROM CALENDAR c
    LEFT JOIN CALENDAR_MEMBER cm
           ON cm.CAL_ID = c.CAL_ID
          AND cm.USER_NO = #{userNo}
    LEFT JOIN MY_ORG mo
           ON 1 = 1
    LEFT JOIN CALENDAR_DEP_SHARE cds
           ON cds.CAL_ID = c.CAL_ID
          AND cds.DEP_ID = mo.DEP_ID
    LEFT JOIN CALENDAR_POS_SHARE cps
           ON cps.CAL_ID = c.CAL_ID
          AND cps.POS_ID = mo.POS_ID
    WHERE c.DELETED_YN = 'N'
      AND (
            c.OWNER_USER_NO = #{userNo}
         OR cm.USER_NO IS NOT NULL
         OR cds.DEP_ID IS NOT NULL
         OR cps.POS_ID IS NOT NULL
      )
    ORDER BY c.CAL_NAME
  </select>

  <!-- 캘린더 단건 조회 -->
  <select id="selectById" parameterType="map"
          resultType="com.kh.coreflow.calendar.model.dto.CalendarDto$DetailRes">
    SELECT <include refid="BaseCols"/>
    FROM CALENDAR
    WHERE CAL_ID = #{calId}
  </select>

  <!-- INSERT -->
  <insert id="insertCalendar" parameterType="map">
    <selectKey keyProperty="calId" resultType="long" order="BEFORE">
      SELECT CALENDAR_SEQ.NEXTVAL FROM DUAL
    </selectKey>
	    INSERT INTO CALENDAR (
	    CAL_ID, CAL_NAME, COLOR, DEFAULT_ROLE,
	    OWNER_USER_NO, DEP_ID, DELETED_YN,
	    CREATE_USER_NO, CREATE_DATE,
	    UPDATE_USER_NO, UPDATE_DATE
	  ) VALUES (
	    #{calId}, #{name}, #{color}, #{defaultRole},
	    #{ownerUserNo},
	    /* dep_id: 파라미터 없으면 내 부서로 자동 채움 */
	    NVL(#{deptId, jdbcType=NUMERIC}, (SELECT DEP_ID FROM MEMBER WHERE USER_NO = #{ownerUserNo})),
	    'N',
	    #{ownerUserNo}, SYSTIMESTAMP,
	    #{ownerUserNo}, SYSTIMESTAMP
	  )
  </insert>

  <!-- UPDATE (소유자만) -->
  <update id="updateCalendar" parameterType="map">
	  UPDATE CALENDAR
	     SET CAL_NAME     = #{name},
	         COLOR        = #{color},
	         DEFAULT_ROLE = #{defaultRole},
	         UPDATE_USER_NO = #{ownerUserNo},
	         UPDATE_DATE  = SYSTIMESTAMP
	   WHERE CAL_ID = #{calId}
	     AND OWNER_USER_NO = #{ownerUserNo}
	     AND DELETED_YN = 'N'
	</update>

  <!-- 논리삭제 (소유자만) -->
  <update id="deleteCalendar" parameterType="map">
    UPDATE CALENDAR
       SET DELETED_YN  = 'Y',
           UPDATE_DATE = SYSTIMESTAMP
     WHERE CAL_ID        = #{calId}
       AND OWNER_USER_NO = #{ownerUserNo}
       AND DELETED_YN    = 'N'
  </update>

  <!-- 캘린더 접근 가능여부(권한 체크) -->
  <select id="existsCalendarAccess" parameterType="map" resultType="int">
    WITH MY_ORG AS (
      SELECT DEP_ID, POS_ID
      FROM MEMBER
      WHERE USER_NO = #{userNo}
    )
    SELECT CASE WHEN COUNT(*) &gt; 0 THEN 1 ELSE 0 END AS hasAccess
    FROM (
      SELECT 1
      FROM CALENDAR c
      LEFT JOIN CALENDAR_MEMBER cm
             ON cm.CAL_ID = c.CAL_ID
            AND cm.USER_NO = #{userNo}
      LEFT JOIN MY_ORG mo
             ON 1 = 1
      LEFT JOIN CALENDAR_DEP_SHARE cds
             ON cds.CAL_ID = c.CAL_ID
            AND cds.DEP_ID = mo.DEP_ID
      LEFT JOIN CALENDAR_POS_SHARE cps
             ON cps.CAL_ID = c.CAL_ID
            AND cps.POS_ID = mo.POS_ID
      WHERE c.CAL_ID = #{calId}
        AND c.DELETED_YN = 'N'
        AND (
              c.OWNER_USER_NO = #{userNo}
           OR cm.USER_NO IS NOT NULL
           OR cds.DEP_ID IS NOT NULL
           OR cps.POS_ID IS NOT NULL
        )
    )
  </select>

</mapper>
